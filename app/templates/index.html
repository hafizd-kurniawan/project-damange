{% extends "base.html" %}

{% block title %}Dashboard - Damage Reporting System{% endblock %}

{% block content %}
{% include "partials/damage_map_tab.html" %}

{% include "partials/manual_upload_tab.html" %}

{% include "partials/reports_list_tab.html" %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
	console.log("Index.html script block loaded.");
	document.addEventListener('DOMContentLoaded', function () {
		// --- Variabel Global & Inisialisasi (dari template.html Anda) ---
		const mapElement = document.getElementById('map');
		if (!mapElement) {
			console.error("Map element not found!");
			return;
		}
		const map = L.map(mapElement).setView([-6.2088, 106.8456], 13); // Default view
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		let damageDataCache = []; // Cache untuk data laporan dari API
		let currentMapMarkers = [];
		const itemsPerPage = 5;
		let currentDamagePageOnMapTab = 1; // Untuk tabel di tab map
		let currentReportsPageOnReportsTab = 1; // Untuk tabel di tab reports

		const damageListTableBody = document.getElementById('damage-list');
		const reportsListTableBody = document.getElementById('reports-list');

		const markerModalElement = document.getElementById('marker-modal');
		const editModalElement = document.getElementById('edit-modal');
		const deleteModalElement = document.getElementById('delete-modal');

		// Input fields untuk Add Marker Modal
		const markerLatInput = document.getElementById('marker-lat');
		const markerLngInput = document.getElementById('marker-lng');
		const markerDamageTypeSelect = document.getElementById('damage-type');
		const markerSeveritySelect = document.getElementById('damage-severity');
		const markerDescriptionTextarea = document.getElementById('damage-description');
		const markerPhotoInput = document.getElementById('photo-input'); // Untuk file upload di modal
		const markerCapturedPhotoImg = document.getElementById('captured-photo'); // Untuk hasil kamera di modal
		const markerCameraResultContainer = document.getElementById('camera-result-container');
		const markerPhotoUploadArea = document.getElementById('photo-upload-area');

		// Input fields untuk Edit Modal
		const editLatInput = document.getElementById('edit-lat');
		const editLngInput = document.getElementById('edit-lng');
		const editDamageTypeSelect = document.getElementById('edit-damage-type');
		const editSeveritySelect = document.getElementById('edit-severity');
		const editDescriptionTextarea = document.getElementById('edit-description');
		const editStatusSelect = document.getElementById('edit-status');
		let editingReportId = null; // Untuk menyimpan ID laporan yang sedang diedit

		// Input fields untuk Manual Upload Tab
		const uploadDamageTypeSelect = document.getElementById('upload-damage-type');
		const uploadSeveritySelect = document.getElementById('upload-severity');
		const uploadLatInput = document.getElementById('upload-lat');
		const uploadLngInput = document.getElementById('upload-lng');
		const manualUploadForm = document.getElementById('upload-form');
		const analyzeBtn = document.getElementById('analyze-btn');
		const submitReportBtn = document.getElementById('submit-report-btn');
		const uploadDescriptionTextarea = document.getElementById('upload-description');
		const manualUploadFileInput = document.getElementById('file-input'); // Input file di tab manual upload
		const manualUploadFilePreview = document.getElementById('file-preview');

		// Elemen kamera
		const cameraContainer = document.getElementById('camera-container');
		const cameraPreviewVideo = document.getElementById('camera-preview'); // <video id="camera-preview">
		const cameraResultVideo = document.getElementById('camera-result'); // <video id="camera-result"> untuk hasil jepretan (sebelumnya img)
		let cameraStream = null;


		// --- Fungsi Fetch Data dari API ---
		async function fetchDamageReports(page = 1, limit = itemsPerPage) {
			console.log(`Workspaceing reports: page=${page}, limit=${limit}`);
			try {
				const response = await fetch(`${API_BASE_URL}/reports/?page=${page}&limit=${limit}`);
				if (!response.ok) {
					const errorData = await response.json().catch(() => ({ detail: "Failed to fetch reports" }));
					throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
				}
				const paginatedData = await response.json();
				console.log("Data diterima dari API:", paginatedData);
				damageDataCache = paginatedData.reports; // Simpan data laporan
				return paginatedData; // Kembalikan data paginasi lengkap
			} catch (error) {
				console.error("Tidak bisa mengambil laporan kerusakan:", error);
				showSuccessModal('Error mengambil data laporan: ' + error.message, false);
				return { reports: [], total_reports: 0, current_page: 1, total_pages: 0 }; // Kembalikan struktur default jika error
			}
		}

		// --- Fungsi Render ---
		function renderAllComponents(paginatedData, activeTab = 'map') {
			if (!paginatedData || !paginatedData.reports) {
				console.error("Data paginasi tidak valid untuk render");
				return;
			}
			console.log("Merender semua komponen dengan data:", paginatedData);

			// Clear marker peta lama
			currentMapMarkers.forEach(marker => map.removeLayer(marker));
			currentMapMarkers.length = 0;

			// Tambah marker baru ke peta
			paginatedData.reports.forEach(damage => {
				const marker = L.marker([damage.lat, damage.lng], {
					icon: L.divIcon({
						html: `<div class="damage-marker">${damage.id}</div>`,
						className: '', iconSize: [20, 20]
					})
				}).addTo(map);

				let popupContent = `<b>Damage ID: ${damage.id}</b><br>Tipe: ${damage.type}`;
				if (damage.photo_url) {
					const photoDisplayUrl = damage.photo_url.startsWith('http') ? damage.photo_url : `${window.location.origin}${damage.photo_url}`;
					// popupContent += `<br><img src="${photoDisplayUrl}" alt="Photo" class="thumbnail" onclick="showImageModal('${photoDisplayUrl}')">`;
				}
				marker.bindPopup(popupContent);
				currentMapMarkers.push(marker);
			});

			// Render tabel berdasarkan tab aktif
			if (activeTab === 'map' || document.getElementById('map-tab').classList.contains('active')) {
				renderTable(damageListTableBody, paginatedData.reports, 'damage', paginatedData.current_page, paginatedData.total_pages, paginatedData.total_reports);
			}
			if (activeTab === 'reports' || document.getElementById('reports-tab').classList.contains('active')) {
				renderTable(reportsListTableBody, paginatedData.reports, 'reports', paginatedData.current_page, paginatedData.total_pages, paginatedData.total_reports);
			}
		}

		function renderTable(tbodyElement, reports, tableType, currentPage, totalPages, totalItems) {
			tbodyElement.innerHTML = ''; // Bersihkan tabel
			if (!reports || reports.length === 0) {
				const tr = tbodyElement.insertRow();
				const td = tr.insertCell();
				td.colSpan = tableType === 'damage' ? 7 : 8;
				td.textContent = 'Tidak ada data laporan.';
				td.className = 'text-center py-4';
			}

			reports.forEach(damage => {
				const row = tbodyElement.insertRow();
				row.className = 'hover:bg-gray-50';
				const photoDisplayUrl = damage.photo_url ? (damage.photo_url.startsWith('http') ? damage.photo_url : `${window.location.origin}${damage.photo_url}`) : null;

				if (tableType === 'damage') { // Tabel di Tab Peta
					row.innerHTML = `
                            <td class="py-3 px-4">${damage.id}</td>
                            <td class="py-3 px-4">${damage.lat.toFixed(4)}, ${damage.lng.toFixed(4)}</td>
                            <td class="py-3 px-4 capitalize">${damage.type}</td>
                            <td class="py-3 px-4">${photoDisplayUrl ? `<img src="${photoDisplayUrl}" class="thumbnail" onclick="showImageModal('${photoDisplayUrl}')">` : 'N/A'}</td>
                            <td class="py-3 px-4">${damage.date_reported}</td>
                            <td class="py-3 px-12">
                                <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="window.focusOnMarker(${damage.id})"><i class="fas fa-map-marker-alt"></i></button>
                            </td>
                        `;
				} else { // Tabel di Tab Laporan Utama
					row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#DR-${String(damage.id).padStart(4, '0')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${damage.lat.toFixed(4)}, ${damage.lng.toFixed(4)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${damage.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${photoDisplayUrl ? `<img src="${photoDisplayUrl}" class="thumbnail" onclick="showImageModal('${photoDisplayUrl}')">` : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${damage.date_reported}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="window.openEditModal(${damage.id})">Edit</button>
                                <button class="text-red-600 hover:text-red-900" onclick="window.openDeleteModal(${damage.id})">Delete</button>
                            </td>
                        `;
				}
			});
			// Render Paginasi
			const paginationElementId = tableType === 'damage' ? 'damage-pagination' : 'reports-pagination';
			renderPaginationControls(paginationElementId, totalPages, currentPage, tableType);
			// Update info range
			if (tableType === 'reports' && document.getElementById('reports-range')) {
				document.getElementById('reports-range').textContent = `${(currentPage - 1) * itemsPerPage + 1}-${Math.min(currentPage * itemsPerPage, totalItems)}`;
				document.getElementById('total-reports').textContent = totalItems;
			}
		}

		function renderPaginationControls(elementId, totalPages, currentPage, tableType) {
			const paginationContainer = document.getElementById(elementId);
			paginationContainer.innerHTML = ''; // Bersihkan tombol yang ada
			if (totalPages <= 1) return;

			const maxButtons = 5; // Maksimal tombol halaman yang ditampilkan

			// Helper function to create a button
			function createButton(text, pageNumber, isDisabled = false, isActive = false) {
				const button = document.createElement('button');
				button.textContent = text;
				button.disabled = isDisabled;
				if (isActive) {
					button.classList.add('active');
				}
				if (isDisabled) {
					button.classList.add('disabled:opacity-50', 'cursor-not-allowed');
				} else {
					button.addEventListener('click', async () => {
						const newData = await fetchDamageReports(pageNumber, itemsPerPage);
						if (tableType === 'damage') {
							currentDamagePageOnMapTab = pageNumber;
						} else {
							currentReportsPageOnReportsTab = pageNumber;
						}
						renderAllComponents(newData, tableType);
					});
				}
				return button;
			}

			// Tombol "Sebelumnya"
			paginationContainer.appendChild(createButton('‹ Prev', currentPage - 1, currentPage === 1));

			if (totalPages <= maxButtons) {
				// Tampilkan semua halaman jika totalnya kurang dari atau sama dengan maxButtons
				for (let i = 1; i <= totalPages; i++) {
					paginationContainer.appendChild(createButton(i, i, false, i === currentPage));
				}
			} else {
				// Logika untuk menampilkan elipsis
				let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
				let endPage = Math.min(totalPages, startPage + maxButtons - 1);

				if (endPage - startPage + 1 < maxButtons) {
					startPage = Math.max(1, endPage - maxButtons + 1);
				}

				if (startPage > 1) {
					paginationContainer.appendChild(createButton(1, 1));
					if (startPage > 2) {
						const ellipsis = document.createElement('span');
						ellipsis.textContent = '...';
						ellipsis.className = 'px-4 py-2';
						paginationContainer.appendChild(ellipsis);
					}
				}

				for (let i = startPage; i <= endPage; i++) {
					paginationContainer.appendChild(createButton(i, i, false, i === currentPage));
				}

				if (endPage < totalPages) {
					if (endPage < totalPages - 1) {
						const ellipsis = document.createElement('span');
						ellipsis.textContent = '...';
						ellipsis.className = 'px-4 py-2';
						paginationContainer.appendChild(ellipsis);
					}
					paginationContainer.appendChild(createButton(totalPages, totalPages));
				}
			}
			// Tombol "Berikutnya"
			paginationContainer.appendChild(createButton('Next ›', currentPage + 1, currentPage === totalPages));
		}


		// --- Fungsi CRUD (Interaksi dengan API) ---
		async function createReport(formData) {
			try {
				const response = await fetch(`${API_BASE_URL}/reports/`, {
					method: 'POST',
					body: formData // FormData akan otomatis set Content-Type ke multipart/form-data
				});
				if (!response.ok) {
					const errorData = await response.json().catch(() => ({ detail: "Gagal membuat laporan" }));
					throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
				}
				const newReport = await response.json();
				showSuccessModal('Laporan berhasil dibuat!');
				// Muat ulang data untuk tab yang aktif
				const activeTabElement = document.querySelector('.tab-btn.active-tab');
				const activeTabName = activeTabElement ? activeTabElement.dataset.tab : 'map';
				refreshActiveTabData(activeTabName);
				return newReport;
			} catch (error) {
				console.error("Error membuat laporan:", error);
				showSuccessModal('Gagal membuat laporan: ' + error.message, false);
			}
		}

		async function updateReport(reportId, updateData, photoFile = null) {
			// Untuk PUT, jika ada file, kita harus kirim sebagai FormData.
			// Jika tidak ada file, kita bisa kirim JSON.
			// Endpoint PUT kita sekarang menerima Form juga.
			const formData = new FormData();
			for (const key in updateData) {
				if (updateData[key] !== null && updateData[key] !== undefined) {
					// Pydantic alias 'type' akan menjadi 'damage_type'
					const formKey = key === 'damage_type' ? 'type_update' : key; // Sesuaikan dengan alias di endpoint PUT
					formData.append(formKey, updateData[key]);
				}
			}
			if (photoFile) {
				formData.append('new_photo', photoFile);
			}

			try {
				const response = await fetch(`${API_BASE_URL}/reports/${reportId}`, {
					method: 'PUT',
					body: formData // Kirim sebagai FormData
				});
				if (!response.ok) {
					const errorData = await response.json().catch(() => ({ detail: "Gagal memperbarui laporan" }));
					throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
				}
				const updatedReport = await response.json();
				showSuccessModal('Laporan berhasil diperbarui!');
				const activeTabElement = document.querySelector('.tab-btn.active-tab');
				const activeTabName = activeTabElement ? activeTabElement.dataset.tab : 'map';
				refreshActiveTabData(activeTabName);
				return updatedReport;
			} catch (error) {
				console.error(`Error memperbarui laporan ${reportId}:`, error);
				showSuccessModal('Gagal memperbarui laporan: ' + error.message, false);
			}
		}

		async function deleteReport(reportId) {
			try {
				const response = await fetch(`${API_BASE_URL}/reports/${reportId}`, {
					method: 'DELETE'
				});
				if (!response.ok) { // 204 No Content juga response.ok == true
					if (response.status !== 204) {
						const errorData = await response.json().catch(() => ({ detail: "Gagal menghapus laporan" }));
						throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
					}
				}
				showSuccessModal('Laporan berhasil dihapus!');
				const activeTabElement = document.querySelector('.tab-btn.active-tab');
				const activeTabName = activeTabElement ? activeTabElement.dataset.tab : 'map';
				refreshActiveTabData(activeTabName);
			} catch (error) {
				console.error(`Error menghapus laporan ${reportId}:`, error);
				showSuccessModal('Gagal menghapus laporan: ' + error.message, false);
			}
		}

		async function refreshActiveTabData(activeTabName = 'map') {
			let currentPage = 1;
			if (activeTabName === 'map') {
				currentPage = currentDamagePageOnMapTab;
			} else if (activeTabName === 'reports') {
				currentPage = currentReportsPageOnReportsTab;
			}
			const newData = await fetchDamageReports(currentPage, itemsPerPage);
			renderAllComponents(newData, activeTabName);
		}


		// --- Event Listeners (dari template.html Anda, dimodifikasi untuk API) ---

		// Tab switching (sudah ada di base.html, tapi ini untuk reload data per tab)
		document.querySelectorAll('.tab-btn').forEach(btn => {
			btn.addEventListener('click', async () => {
				document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active-tab'); b.classList.add('text-gray-600'); });
				document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

				btn.classList.add('active-tab');
				btn.classList.remove('text-gray-600');
				const tabId = btn.getAttribute('data-tab');
				document.getElementById(`${tabId}-tab`).classList.add('active');

				// Muat data untuk tab yang baru diaktifkan
				await refreshActiveTabData(tabId);
			});
		});

		// Add Marker Modal
		// let clickMapMarker = null; // Temporary marker di peta
		// document.getElementById('add-marker-btn').addEventListener('click', () => {
		// 	map.once('click', function (e) { // Gunakan 'once' agar event listener dilepas setelah satu klik
		// 		if (clickMapMarker) map.removeLayer(clickMapMarker);
		// 		clickMapMarker = L.marker(e.latlng, {
		// 			icon: L.divIcon({ html: '<div class="damage-marker" style="background-color: #3b82f6;">+</div>', className: '', iconSize: [20, 20] })
		// 		}).addTo(map);

		// 		markerLatInput.value = e.latlng.lat.toFixed(6);
		// 		markerLngInput.value = e.latlng.lng.toFixed(6);
		// 		markerModalElement.classList.remove('hidden');
		// 		// Reset form modal
		// 		document.getElementById('marker-modal').querySelector('form')?.reset();
		// 		markerCapturedPhotoImg.src = '';
		// 		markerCameraResultContainer.classList.add('hidden');
		// 		markerPhotoUploadArea.classList.remove('hidden');
		// 		markerPhotoInput.value = ''; // Reset file input
		// 	});
		// 	showSuccessModal("Klik di peta untuk menandai lokasi kerusakan.", true);
		// });

		// document.getElementById('cancel-marker').addEventListener('click', () => {
		// 	markerModalElement.classList.add('hidden');
		// 	if (clickMapMarker) map.removeLayer(clickMapMarker);
		// 	clickMapMarker = null;
		// });

		document.getElementById('marker-modal').querySelector('form').addEventListener('submit', async function (e) {
			e.preventDefault();
			const formData = new FormData();
			formData.append('lat', markerLatInput.value);
			formData.append('lng', markerLngInput.value);
			formData.append('type', markerDamageTypeSelect.value); // 'type' akan dihandle aliasnya oleh Pydantic/FastAPI
			// formData.append('severity', markerSeveritySelect.value);
			formData.append('description', markerDescriptionTextarea.value);

			if (markerPhotoInput.files[0]) {
				formData.append('photo', markerPhotoInput.files[0]);
			} else if (markerCapturedPhotoImg.src && markerCapturedPhotoImg.src.startsWith('data:')) {
				// Konversi data URL ke Blob
				const blob = await (await fetch(markerCapturedPhotoImg.src)).blob();
				formData.append('photo', blob, `camera_capture_${Date.now()}.png`);
			}

			await createReport(formData);
			markerModalElement.classList.add('hidden');
			if (clickMapMarker) map.removeLayer(clickMapMarker);
			clickMapMarker = null;
		});

		// Photo upload di Add Marker Modal
		markerPhotoUploadArea.addEventListener('click', () => markerPhotoInput.click());
		markerPhotoInput.addEventListener('change', function () {
			if (this.files && this.files[0]) {
				const reader = new FileReader();
				reader.onload = (e) => {
					markerCapturedPhotoImg.src = e.target.result;
					markerCameraResultContainer.classList.remove('hidden');
					markerPhotoUploadArea.classList.add('hidden');
				};
				reader.readAsDataURL(this.files[0]);
			}
		});


		// Edit Modal
		window.openEditModal = async (reportId) => {
			try {
				// Ambil data laporan terbaru dari API
				const response = await fetch(`${API_BASE_URL}/reports/${reportId}`);
				if (!response.ok) throw new Error("Gagal mengambil data laporan untuk diedit.");
				const report = await response.json();

				editingReportId = report.id;
				editLatInput.value = report.lat;
				editLngInput.value = report.lng;
				editDamageTypeSelect.value = report.damage_type; // Gunakan field asli dari API
				// editSeveritySelect.value = report.severity;
				editDescriptionTextarea.value = report.description || '';
				editStatusSelect.value = report.status;
				// Untuk edit foto, mungkin perlu UI yang lebih kompleks atau serahkan ke tombol "upload new photo"
				editModalElement.classList.remove('hidden');
			} catch (error) {
				console.error("Error membuka edit modal:", error);
				showSuccessModal("Gagal memuat data untuk diedit: " + error.message, false);
			}
		};

		document.getElementById('cancel-edit').addEventListener('click', () => {
			editModalElement.classList.add('hidden');
			editingReportId = null;
		});

		document.getElementById('edit-modal').querySelector('form').addEventListener('submit', async function (e) {
			e.preventDefault();
			if (editingReportId === null) return;

			const updatePayload = { // Ini adalah objek ReportUpdate Pydantic
				lat: parseFloat(editLatInput.value) || null,
				lng: parseFloat(editLngInput.value) || null,
				damage_type: editDamageTypeSelect.value || null, // Pydantic akan handle alias 'type'
				// severity: editSeveritySelect.value || null,
				description: editDescriptionTextarea.value || null,
				status: editStatusSelect.value || null
			};
			// Hapus field null agar tidak terkirim dan menimpa nilai yang ada dengan null
			Object.keys(updatePayload).forEach(key => {
				if (updatePayload[key] === null || updatePayload[key] === '') {
					delete updatePayload[key];
				}
			});
			// Untuk update foto, kita akan menggunakan parameter 'new_photo' di endpoint PUT
			// Jika ada input file terpisah untuk edit foto, ambil dari sana.
			// Untuk sekarang, kita asumsikan update foto dilakukan via field File terpisah di PUT.

			await updateReport(editingReportId, updatePayload /*, newPhotoFile jika ada */);
			editModalElement.classList.add('hidden');
			editingReportId = null;
		});

		// Delete Modal
		let reportIdToDelete = null;
		window.openDeleteModal = (reportId) => {
			reportIdToDelete = reportId;
			deleteModalElement.classList.remove('hidden');
		};
		document.getElementById('cancel-delete').addEventListener('click', () => {
			deleteModalElement.classList.add('hidden');
			reportIdToDelete = null;
		});
		document.getElementById('confirm-delete').addEventListener('click', async () => {
			if (reportIdToDelete === null) return;
			await deleteReport(reportIdToDelete);
			deleteModalElement.classList.add('hidden');
			reportIdToDelete = null;
		});


		// 4. Reset form ke keadaan awal
		manualUploadFilePreview.innerHTML = '';
		analyzeBtn.disabled = true;
		uploadDamageTypeSelect.disabled = true;
		uploadDamageTypeSelect.value = "";
		submitReportBtn.disabled = true;
		// 1. Aktifkan tombol "Analisis" hanya jika ada file yang dipilih
		manualUploadFileInput.addEventListener('change', function () {
			manualUploadFilePreview.innerHTML = ''; // Bersihkan preview lama
			if (this.files && this.files.length > 0) {
				for (const file of this.files) {
					const p = document.createElement('p');
					p.textContent = file.name;
					manualUploadFilePreview.appendChild(p);
				}
				analyzeBtn.disabled = false; // Aktifkan tombol analisis
			} else {
				analyzeBtn.disabled = true; // Nonaktifkan jika tidak ada file
			}
			// Pastikan tombol submit dan dropdown tetap nonaktif
			submitReportBtn.disabled = true;
			uploadDamageTypeSelect.disabled = true;
			uploadDamageTypeSelect.value = ""; // Reset pilihan
		});

		// 2. Logika untuk tombol "Analisis Kerusakan"
		analyzeBtn.addEventListener('click', async () => {

			if (!manualUploadFileInput.files || manualUploadFileInput.files.length === 0) {
				showSuccessModal("Silakan pilih file gambar terlebih dahulu.", false);
				return;
			}

			const file = manualUploadFileInput.files[0];
			const formData = new FormData();
			formData.append('photo', file);

			// Tampilkan status "menganalisis"
			showSuccessModal("Menganalisis kerusakan pada gambar...", true);
			analyzeBtn.disabled = true;
			analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Menganalisis...';

			try {
				// Panggil API backend untuk analisis
				const response = await fetch(`${API_BASE_URL}/reports/analyze-image`, {
					method: 'POST',
					body: formData,
				});

				// Tutup modal pesan loading
				document.getElementById('close-success').click();

				if (!response.ok) {
					const errorData = await response.json().catch(() => ({ detail: "Gagal menganalisis gambar." }));
					throw new Error(errorData.detail || `Error: ${response.status}`);
				}

				const result = await response.json(); // Hasilnya adalah: { detected_type: "pothole" }
				const detectedType = result.detected_type;

				showSuccessModal(`Analisis selesai! Terdeteksi: ${detectedType}. Silakan periksa dan submit.`, true);

				// Aktifkan dropdown dan atur nilainya sesuai hasil
				uploadDamageTypeSelect.disabled = false;

				// Cek apakah hasil deteksi ada di dalam opsi dropdown
				const optionExists = [...uploadDamageTypeSelect.options].some(opt => opt.value === detectedType);
				if (optionExists) {
					uploadDamageTypeSelect.value = detectedType;
					submitReportBtn.disabled = false; // Aktifkan submit jika jenis terdeteksi
				} else {
					// Jika jenis kerusakan tidak ada di daftar, minta pengguna memilih manual
					uploadDamageTypeSelect.value = ""; // Kosongkan pilihan
					submitReportBtn.disabled = true;
					showSuccessModal(`Deteksi: ${detectedType}. Jenis ini tidak ada di daftar, silakan pilih manual.`, false);
				}

			} catch (error) {
				console.error("Error saat analisis:", error);
				showSuccessModal(`Gagal menganalisis: ${error.message}`, false);
				// Biarkan dropdown nonaktif jika analisis gagal
				uploadDamageTypeSelect.disabled = true;
				submitReportBtn.disabled = true;
			} finally {
				// Kembalikan tombol analisis ke keadaan semula
				analyzeBtn.innerHTML = '<i class="fas fa-search-plus mr-2"></i> Analisis Kerusakan';
				// Biarkan tombol analisis aktif lagi untuk mencoba lagi jika perlu
				analyzeBtn.disabled = false;
			}
		});

		// 3. Aktifkan/nonaktifkan tombol submit berdasarkan pilihan dropdown
		uploadDamageTypeSelect.addEventListener('change', function () {
			if (this.value) {
				submitReportBtn.disabled = false;
			} else {
				submitReportBtn.disabled = true;
			}
		});

		// Manual Upload Tab Form
		document.getElementById('upload-form').addEventListener('submit', async function (e) {
			e.preventDefault();
			const formData = new FormData();
			formData.append('lat', uploadLatInput.value);
			formData.append('lng', uploadLngInput.value);
			formData.append('type', uploadDamageTypeSelect.value);
			formData.append('description', uploadDescriptionTextarea.value);
			if (manualUploadFileInput.files[0]) {
				formData.append('photo', manualUploadFileInput.files[0]);
			}

			if (!uploadDamageTypeSelect.value) { showSuccessModal('Pilih jenis kerusakan.', false); return; }
			if (!uploadLatInput.value || !uploadLngInput.value) { showSuccessModal('Koordinat wajib diisi.', false); return; }

			await createReport(formData);
			this.reset(); // Reset form
			manualUploadFilePreview.innerHTML = '';
			analyzeBtn.disabled = true;
			uploadDamageTypeSelect.disabled = true;
			uploadDamageTypeSelect.value = "";
			submitReportBtn.disabled = true;
		});

		// File input di Manual Upload Tab
		const manualUploadArea = document.getElementById('file-upload-area');
		manualUploadArea.addEventListener('click', () => manualUploadFileInput.click());
		// (Tambahkan event listener untuk drag & drop, dan file preview jika perlu, mirip handleFiles di template asli Anda)
		manualUploadFileInput.addEventListener('change', function () {
			manualUploadFilePreview.innerHTML = ''; // Clear previous previews
			if (this.files && this.files.length > 0) {
				for (const file of this.files) {
					const p = document.createElement('p');
					p.textContent = file.name;
					manualUploadFilePreview.appendChild(p);
				}
			}
		});
		document.getElementById('get-location-btn').addEventListener('click', () => {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					pos => { uploadLatInput.value = pos.coords.latitude.toFixed(6); uploadLngInput.value = pos.coords.longitude.toFixed(6); },
					err => { showSuccessModal('Gagal mendapatkan lokasi: ' + err.message, false); }
				);
			} else { showSuccessModal('Geolocation tidak didukung browser ini.', false); }
		});

		let selectionMap;
		let selectionMarker;
		document.getElementById('select-on-map-btn').addEventListener('click', () => {
			document.getElementById('map-selection-modal').classList.remove('hidden');

			// Initialize selection map if not already done
			if (!selectionMap) {
				selectionMap = L.map('selection-map').setView([-6.2088, 106.8456], 13);
				L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				}).addTo(selectionMap);

				// Add click handler for selection
				selectionMap.on('click', (e) => {
					const lat = e.latlng.lat.toFixed(6);
					const lng = e.latlng.lng.toFixed(6);

					document.getElementById('selection-lat').value = lat;
					document.getElementById('selection-lng').value = lng;

					// Update marker position
					if (selectionMarker) {
						selectionMarker.setLatLng(e.latlng);
					} else {
						selectionMarker = L.marker(e.latlng, {
							icon: L.divIcon({
								html: '<div class="damage-marker" style="background-color: #3b82f6;">+</div>',
								className: '',
								iconSize: [20, 20]
							})
						}).addTo(selectionMap);
					}
				});
			}

			// Set current values if any
			const currentLat = document.getElementById('upload-lat').value;
			const currentLng = document.getElementById('upload-lng').value;

			if (currentLat && currentLng) {
				const latLng = [parseFloat(currentLat), parseFloat(currentLng)];
				selectionMap.setView(latLng, 15);
				document.getElementById('selection-lat').value = currentLat;
				document.getElementById('selection-lng').value = currentLng;

				if (selectionMarker) {
					selectionMarker.setLatLng(latLng);
				} else {
					selectionMarker = L.marker(latLng, {
						icon: L.divIcon({
							html: '<div class="damage-marker" style="background-color: #3b82f6;">+</div>',
							className: '',
							iconSize: [20, 20]
						})
					}).addTo(selectionMap);
				}
			}
		});

		// Confirm selection handler
		document.getElementById('confirm-selection').addEventListener('click', () => {
			const lat = document.getElementById('selection-lat').value;
			const lng = document.getElementById('selection-lng').value;

			if (lat && lng) {
				document.getElementById('upload-lat').value = lat;
				document.getElementById('upload-lng').value = lng;
				document.getElementById('map-selection-modal').classList.add('hidden');
			} else {
				alert('Please select a location on the map');
			}
		});

		// Cancel selection handler
		document.getElementById('cancel-selection').addEventListener('click', () => {
			document.getElementById('map-selection-modal').classList.add('hidden');
		});


		// Fungsi fokus marker di peta
		window.focusOnMarker = (reportId) => {
			const report = damageDataCache.find(d => d.id === reportId);
			if (report) {
				map.setView([report.lat, report.lng], 16); // Zoom lebih dekat
				// Cari marker yang sesuai untuk dibuka pop-upnya (agak rumit jika marker dibuat ulang terus)
				// Cara sederhana: buka popup marker terakhir yang cocok dengan ID jika ada
				// Atau, loop currentMapMarkers, cari yang lat/lng-nya cocok
				currentMapMarkers.forEach(m => {
					const markerLatLng = m.getLatLng();
					if (markerLatLng.lat === report.lat && markerLatLng.lng === report.lng) {
						m.openPopup();
					}
				});
			}
		};

		// --- Logika Kamera (dari template.html Anda, disesuaikan) ---
		// const useCameraBtn = document.getElementById('use-camera-btn');
		// const takePhotoBtnCamera = document.getElementById('take-photo-btn'); // Tombol di dalam area kamera
		// const cancelCameraBtnCamera = document.getElementById('cancel-camera-btn'); // Tombol di dalam area kamera
		// if (useCameraBtn) {
		// 	useCameraBtn.addEventListener('click', async () => {
		// 		try {
		// 			document.getElementById('map-tab').querySelector('#map').classList.add('hidden'); // Sembunyikan peta di tab map
		// 			cameraContainer.classList.remove('hidden');
		// 			cameraPreviewVideo.style.display = 'block';
		// 			cameraResultVideo.style.display = 'none'; // Sembunyikan hasil video/gambar awal

		// 			cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
		// 			cameraPreviewVideo.srcObject = cameraStream;
		// 			// cameraPreviewVideo.play(); // autoplay sudah ada di tag video
		// 		} catch (err) {
		// 			console.error('Error mengakses kamera:', err);
		// 			showSuccessModal('Tidak bisa mengakses kamera: ' + err.message, false);
		// 			cameraContainer.classList.add('hidden');
		// 			document.getElementById('map-tab').querySelector('#map').classList.remove('hidden');
		// 		}
		// 	});
		// }

		// if (takePhotoBtnCamera) {
		// 	takePhotoBtnCamera.addEventListener('click', () => {
		// 		if (!cameraStream || !cameraPreviewVideo.srcObject) {
		// 			showSuccessModal("Kamera belum aktif.", false);
		// 			return;
		// 		}
		// 		const canvas = document.createElement('canvas');
		// 		canvas.width = cameraPreviewVideo.videoWidth;
		// 		canvas.height = cameraPreviewVideo.videoHeight;
		// 		const ctx = canvas.getContext('2d');
		// 		ctx.drawImage(cameraPreviewVideo, 0, 0, canvas.width, canvas.height);

		// 		const imageDataUrl = canvas.toDataURL('image/png');

		// 		// Hentikan stream kamera setelah foto diambil
		// 		if (cameraStream) {
		// 			cameraStream.getTracks().forEach(track => track.stop());
		// 			cameraStream = null;
		// 			cameraPreviewVideo.srcObject = null; // Hapus stream dari elemen video
		// 		}
		// 		cameraPreviewVideo.style.display = 'none'; // Sembunyikan preview
		// 		cameraContainer.classList.add('hidden'); // Sembunyikan kontrol kamera
		// 		document.getElementById('map-tab').querySelector('#map').classList.remove('hidden'); // Tampilkan peta kembali

		// 		// Masukkan hasil foto ke modal penambahan marker
		// 		markerCapturedPhotoImg.src = imageDataUrl;
		// 		markerCameraResultContainer.classList.remove('hidden');
		// 		markerPhotoUploadArea.classList.add('hidden');
		// 		markerPhotoInput.value = ''; // Kosongkan file input jika ada

		// 		// Buka modal marker (jika belum terbuka) atau biarkan user klik di peta dulu
		// 		// Untuk alur ini, kita asumsikan user sudah klik peta atau akan klik peta
		// 		if (!markerModalElement.classList.contains('hidden')) {
		// 			// Modal sudah terbuka, foto siap digunakan
		// 		} else {
		// 			// Jika modal belum terbuka, mungkin beri instruksi untuk klik peta
		// 			showSuccessModal("Foto diambil. Sekarang klik di peta untuk menandai lokasi dan mengisi detail.", true);
		// 			map.once('click', function (e) {
		// 				if (clickMapMarker) map.removeLayer(clickMapMarker);
		// 				clickMapMarker = L.marker(e.latlng, {
		// 					icon: L.divIcon({ html: '<div class="damage-marker" style="background-color: #3b82f6;">+</div>', className: '', iconSize: [20, 20] })
		// 				}).addTo(map);
		// 				markerLatInput.value = e.latlng.lat.toFixed(6);
		// 				markerLngInput.value = e.latlng.lng.toFixed(6);
		// 				// Foto sudah ada di markerCapturedPhotoImg
		// 				markerModalElement.classList.remove('hidden');
		// 			});
		// 		}
		// 	});
		// }

		// if (cancelCameraBtnCamera) {
		// 	cancelCameraBtnCamera.addEventListener('click', () => {
		// 		if (cameraStream) {
		// 			cameraStream.getTracks().forEach(track => track.stop());
		// 			cameraStream = null;
		// 			cameraPreviewVideo.srcObject = null;
		// 		}
		// 		cameraPreviewVideo.style.display = 'none';
		// 		cameraContainer.classList.add('hidden');
		// 		document.getElementById('map-tab').querySelector('#map').classList.remove('hidden');
		// 	});
		// }

		// Realtime Detection Functionality (using your code)
		const realtimeVideo = document.getElementById('realtime-video');
		const realtimeCanvas = document.getElementById('realtime-canvas');
		const realtimeCtx = realtimeCanvas.getContext('2d');
		const realtimeOutput = document.getElementById('realtime-output');
		const realtimeOutCtx = realtimeOutput.getContext('2d');
		const realtimeCameraSelect = document.getElementById('realtime-camera-select');
		const startRealtimeBtn = document.getElementById('start-realtime-btn');
		const stopRealtimeBtn = document.getElementById('stop-realtime-btn');
		const captureRealtimeBtn = document.getElementById('capture-realtime-btn');
		const toggleRealtimeBtn = document.getElementById('toggle-realtime-btn');
		const realtimeDetectionContainer = document.getElementById('realtime-detection-container');
		const WS_URL = BASE_URL + "ws"

		let currentRealtimeStream = null;
		let realtimeClientLocation = { lat: null, lon: null };
		let realtimeWsConnection = null;
		let ws = null;
		// let cameraStream = null;
		let sendFrameIntervalId = null;
		let latestDetections = [];
		let animationFrameId = null;
		let isStartingStream = false; //


		//======================================================================
		// REFERENSI ELEMEN DOM (DENGAN PENGECEKAN)
		//======================================================================
		// Memastikan elemen ada sebelum digunakan untuk mencegah error "null".
		// const realtimeVideo = document.getElementById('realtime-video');
		const overlayCanvas = document.getElementById('realtime-output');
		const cameraSelect = document.getElementById('realtime-camera-select');
		const startBtn = document.getElementById('start-realtime-btn');
		const stopBtn = document.getElementById('stop-realtime-btn');
		const toggleBtn = document.getElementById('toggle-realtime-btn');
		const realtimeContainer = document.getElementById('realtime-detection-container');
		// Konteks canvas hanya diambil jika canvas ada
		const overlayCtx = overlayCanvas ? overlayCanvas.getContext('2d', { willReadFrequently: true }) : null;


		//======================================================================
		// REFERENSI ELEMEN DOM (DENGAN PENGECEKAN)
		//======================================================================


		//======================================================================
		// FUNGSI KHUSUS UNTUK REAL-TIME DETECTION (FOKUS UTAMA)
		//======================================================================

		/**
		 * Loop rendering utama. Menggambar kotak deteksi di atas video.
		 */
		function drawDetectionLoop() {
			if (realtimeContainer && !realtimeContainer.classList.contains('hidden') && cameraStream) {
				const videoWidth = realtimeVideo.videoWidth;
				const videoHeight = realtimeVideo.videoHeight;

				if (overlayCanvas.width !== videoWidth || overlayCanvas.height !== videoHeight) {
					overlayCanvas.width = videoWidth;
					overlayCanvas.height = videoHeight;
				}

				overlayCtx.clearRect(0, 0, videoWidth, videoHeight);

				latestDetections.forEach(det => {
					const [x1, y1, x2, y2] = det.box;
					const score = (det.score * 100).toFixed(1);
					const label = `${det.class_name} ${score}%`;

					overlayCtx.strokeStyle = 'rgba(255, 26, 26, 0.9)';
					overlayCtx.lineWidth = 3;
					overlayCtx.strokeRect(x1, y1, x2 - x1, y2 - y1);

					overlayCtx.fillStyle = 'rgba(255, 26, 26, 0.9)';
					overlayCtx.font = 'bold 16px sans-serif';
					overlayCtx.fillText(label, x1, y1 > 20 ? y1 - 10 : y1 + 20);
				});
			}
			animationFrameId = requestAnimationFrame(drawDetectionLoop);
		}

		/**
		 * Mengambil snapshot dari video dan mengirimkannya ke server WebSocket.
		 */
		function sendFrameToServer() {
			if (!ws || ws.readyState !== WebSocket.OPEN || !cameraStream || !realtimeVideo || realtimeVideo.videoWidth === 0) {
				return;
			}

			const tempCanvas = document.createElement('canvas');
			tempCanvas.width = realtimeVideo.videoWidth;
			tempCanvas.height = realtimeVideo.videoHeight;
			const tempCtx = tempCanvas.getContext('2d');
			tempCtx.drawImage(realtimeVideo, 0, 0, tempCanvas.width, tempCanvas.height);

			tempCanvas.toBlob(blob => {
				if (blob && ws && ws.readyState === WebSocket.OPEN) {
					ws.send(blob);
				}
			}, 'image/jpeg', 0.7);
		}

		/**
		 * Mengatur event handler untuk koneksi WebSocket.
		 */
		function setupWebSocketHandlers(socket) {
			socket.onopen = () => {
				console.log("WebSocket terhubung. Memulai pengiriman frame...");
				if (sendFrameIntervalId) clearInterval(sendFrameIntervalId);
				sendFrameIntervalId = setInterval(sendFrameToServer, 150);
			};

			socket.onmessage = (event) => {
				try {
					const data = JSON.parse(event.data);
					if (data.detections) {
						latestDetections = data.detections;
					}
				} catch (e) {
					console.error("Gagal mem-parse pesan WebSocket:", e);
				}
			};

			socket.onclose = () => {
				console.log("WebSocket terputus.");
				// Tidak perlu memanggil stopRealtimeDetection() di sini karena
				// stopRealtimeDetection() sendiri yang akan memicu onclose.
			};

			socket.onerror = (error) => {
				console.error("WebSocket Error:", error);
				stopRealtimeDetection();
			};
		}

		/**
		 * Menghentikan stream kamera, koneksi WebSocket, dan membersihkan semua state.
		 * Fungsi ini dibuat agar aman untuk dipanggil beberapa kali.
		 */
		function stopRealtimeDetection() {
			if (sendFrameIntervalId) {
				clearInterval(sendFrameIntervalId);
				sendFrameIntervalId = null;
			}
			if (ws) {
				// Hapus event handler onclose sebelum menutup untuk mencegah loop
				ws.onclose = null;
				ws.close();
				ws = null;
			}
			if (cameraStream) {
				cameraStream.getTracks().forEach(track => track.stop());
				cameraStream = null;
			}

			if (realtimeVideo) realtimeVideo.srcObject = null;
			latestDetections = [];

			if (overlayCtx) {
				overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
			}

			if (startBtn) startBtn.disabled = false;
			if (stopBtn) stopBtn.disabled = true;
		}

		/**
		 * Memulai stream kamera dan koneksi WebSocket. Ini adalah fungsi inti yang dipanggil oleh tombol Start.
		 */
		async function startRealtimeDetection() {
			stopRealtimeDetection(); // Pastikan semua state lama dibersihkan

			if (startBtn) {
				startBtn.disabled = true;
				startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memulai...';
			}

			try {
				const constraints = { video: { facingMode: cameraSelect.value } };
				cameraStream = await navigator.mediaDevices.getUserMedia(constraints);

				realtimeVideo.srcObject = cameraStream;

				// Tunggu hingga metadata video tersedia, baru play
				await new Promise((resolve) => {
					realtimeVideo.onloadedmetadata = () => {
						resolve();
					};
				});

				await realtimeVideo.play(); // Sekarang aman untuk play

				if (stopBtn) stopBtn.disabled = false;

				// Buat koneksi WebSocket baru
				ws = new WebSocket(WS_URL);
				setupWebSocketHandlers(ws);

			} catch (err) {
				console.error("Gagal memulai deteksi real-time:", err);
				if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
					alert("Akses kamera ditolak. Harap berikan izin pada browser.");
				} else if (err.name !== "AbortError") {
					alert("Gagal mengakses kamera. Pastikan tidak ada aplikasi lain yang sedang menggunakannya.");
				}
				stopRealtimeDetection();
			} finally {
				if (startBtn) {
					startBtn.innerHTML = 'Start Detection';
					startBtn.disabled = !!cameraStream;
				}
			}
		}


		//======================================================================
		// PENDAFTARAN EVENT LISTENER (dengan pengecekan elemen)
		//======================================================================

		if (toggleBtn && realtimeContainer) {
			toggleBtn.addEventListener('click', () => {
				const isHidden = realtimeContainer.classList.toggle('hidden');
				if (isHidden) {
					stopRealtimeDetection();
					toggleBtn.innerHTML = '<i class="fas fa-camera mr-2"></i> Aktifkan Deteksi Real-time';
				} else {
					toggleBtn.innerHTML = '<i class="fas fa-eye-slash mr-2"></i> Sembunyikan Deteksi Real-time';
				}
			});
		}

		if (startBtn) startBtn.addEventListener('click', startRealtimeDetection);
		if (stopBtn) stopBtn.addEventListener('click', stopRealtimeDetection);
		if (cameraSelect) cameraSelect.addEventListener('change', startRealtimeDetection);


		//======================================================================
		// INISIALISASI APLIKASI
		//======================================================================
		function initializeApp() {
			console.log("Aplikasi Dimuat...");
			if (realtimeVideo && overlayCanvas && cameraSelect && startBtn && stopBtn && toggleBtn && realtimeContainer) {
				console.log("Fitur deteksi real-time diinisialisasi.");
				drawDetectionLoop();
			} else {
				console.error("Satu atau lebih elemen HTML untuk deteksi real-time tidak ditemukan. Fitur tidak akan aktif.");
			}
			// ... panggil fungsi inisialisasi lain di sini jika ada
		}


		// Camera type selection
		async function startRealtimeCamera(facingMode) {
			if (currentRealtimeStream) {
				stopRealtimeMediaTracks(currentRealtimeStream);
			}

			try {
				const constraints = {
					video: { facingMode: facingMode }
				};
				currentRealtimeStream = await navigator.mediaDevices.getUserMedia(constraints);
				realtimeVideo.srcObject = currentRealtimeStream;

				// Start WebSocket connection
				connectRealtimeWebSocket();
			} catch (err) {
				alert("Failed to access camera: " + err);
			}
		}

		realtimeCameraSelect.addEventListener('change', () => {
			const selected = realtimeCameraSelect.value;
			startRealtimeCamera(selected);
		});

		// Start realtime detection button
		startRealtimeBtn.addEventListener('click', () => {
			const selected = realtimeCameraSelect.value;
			startRealtimeCamera(selected);
		});

		// Stop realtime detection button
		stopRealtimeBtn.addEventListener('click', () => {
			if (currentRealtimeStream) {
				stopRealtimeMediaTracks(currentRealtimeStream);
				currentRealtimeStream = null;
				realtimeVideo.srcObject = null;
			}

			// Close WebSocket connection
			if (realtimeWsConnection) {
				realtimeWsConnection.close();
				realtimeWsConnection = null;
			}
		});

		// Capture button for realtime detection
		captureRealtimeBtn.addEventListener('click', () => {
			if (realtimeVideo.readyState === realtimeVideo.HAVE_ENOUGH_DATA) {
				// Create canvas to capture image
				const canvas = document.createElement('canvas');
				canvas.width = realtimeVideo.videoWidth;
				canvas.height = realtimeVideo.videoHeight;
				const ctx = canvas.getContext('2d');
				ctx.drawImage(realtimeVideo, 0, 0, canvas.width, canvas.height);

				// Create image preview
				const dataURL = canvas.toDataURL('image/png');
				const previewItem = document.createElement('div');
				previewItem.className = 'border rounded-lg overflow-hidden bg-white';
				previewItem.innerHTML = `
		            <div class="relative">
		                <img src="${dataURL}" alt="Captured photo" class="w-full h-32 object-cover">
		                <div class="absolute top-2 right-2 bg-white rounded-full p-1 shadow">
		                    <button class="text-red-500" onclick="this.parentElement.parentElement.parentElement.remove()">
		                        <i class="fas fa-times"></i>
		                    </button>
		                </div>
		            </div>
		            <div class="p-2">
		                <p class="text-sm font-medium truncate">capture_${new Date().toISOString().slice(0, 10)}.png</p>
		            </div>
		        `;

				// Add to file preview in upload tab
				document.getElementById('file-preview').appendChild(previewItem);

				// Auto-fill coordinates if available
				if (realtimeClientLocation.lat && realtimeClientLocation.lon) {
					document.getElementById('upload-lat').value = realtimeClientLocation.lat.toFixed(6);
					document.getElementById('upload-lng').value = realtimeClientLocation.lon.toFixed(6);
				}

				// Switch to upload tab
				document.querySelector('[data-tab="upload"]').click();
			}
		});





		// Muat data awal untuk tab map (yang aktif pertama)
		async function initialLoad() {
			const initialData = await fetchDamageReports(currentDamagePageOnMapTab, itemsPerPage);
			renderAllComponents(initialData, 'map');
		}
		initialLoad();
		initializeApp();

	}); // Akhir dari DOMContentLoaded
</script>
{% endblock %}